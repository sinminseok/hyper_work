# 경기별 순위 계산 규칙

## 공통 규칙

### 완주 조건
- `현재 거리 >= 목표 거리`
- 워치에서 측정한 거리가 목표 거리에 도달하면 자동 완주 처리
- **경기 시작 시간 (`startAt`)**: 첫 번째 웹소켓 데이터 수신 시점
- **경기 완주 시간 (`endAt`)**: 목표 거리 도달 시점
- **경기 소요 시간**: `endAt - startAt` (초 단위)

### 완주 우선 원칙
- **SPEED 경기**: 완주자가 미완주자보다 무조건 높은 순위
- **CADENCE, HEARTBEAT 경기**: 완주자가 미완주자보다 무조건 높은 순위

### 순위 계산 주기
- **15초마다** 자동으로 순위 재계산
- 경기 종료 시 최종 순위 확정 및 상금 지급

### 평균 계산 방식
- 워치에서 5초마다 데이터 전송 시 **누적 평균** 계산
- 평균 심박수 = (기존 평균 × 이전 횟수 + 새 값) / 전체 횟수
- 평균 케이던스 = (기존 평균 × 이전 횟수 + 새 값) / 전체 횟수

---

## 경기 타입별 규칙

### 1️⃣ SPEED 경기 (스피드)

**목표:** 목표 거리를 가장 빨리 완주

**순위 결정 기준 (우선순위):**
1. **완주 여부** (완주 > 미완주)
2. **경기 소요 시간** (`endAt - startAt`, 짧을수록 높은 순위)
3. **남은 거리** (미완주자: 적을수록 높은 순위)

**예시:**

| 사용자 | 목표 거리 | 시작 시간 | 완주 시간 | 소요 시간 | 완주 여부 | 순위 |
|--------|----------|----------|----------|----------|----------|------|
| B | 5000m | 10:00 | 10:29 | 29분 | ✅ 완주 | 1위 (소요 시간 짧음) |
| A | 5000m | 10:00 | 10:30 | 30분 | ✅ 완주 | 2위 |
| C | 5000m | 10:00 | - | - | ❌ 미완주 (4800m) | 3위 |
| D | 5000m | 10:00 | - | - | ❌ 미완주 (3000m) | 4위 |

**특징:**
- 초 단위로 소요 시간을 기록하므로 **동점자는 없다고 가정**
- 경기 소요 시간이 짧은 순서대로 순위 결정

---

### 2️⃣ CADENCE 경기 (케이던스)

**목표:** 목표 케이던스를 유지하면서 완주

**신청 시:**
- 사용자가 원하는 목표 케이던스를 직접 입력 (예: 180 spm)

**순위 결정 기준 (우선순위):**
1. **완주 여부** (완주 > 미완주)
2. **케이던스 점수** = `|목표 케이던스 - 평균 케이던스|` (작을수록 높은 순위)
3. **동점 시**: 경기 소요 시간 짧은 순 (`endAt - startAt`)

**예시:**

| 사용자 | 목표 케이던스 | 평균 케이던스 | 점수 | 소요 시간 | 완주 여부 | 순위 |
|--------|-------------|--------------|------|----------|----------|------|
| A | 180 spm | 180.5 spm | 0.5 | 30분 | ✅ 완주 | 1위 (점수 최소) |
| E | 180 spm | 181.0 spm | 1.0 | 35분 | ✅ 완주 | 2위 |
| B | 180 spm | 178.0 spm | 2.0 | 28분 | ✅ 완주 | 3위 (동점, 소요 시간 짧음) |
| C | 180 spm | 178.0 spm | 2.0 | 32분 | ✅ 완주 | 4위 (동점, 소요 시간 김) |
| D | 180 spm | 175.0 spm | 5.0 | 35분 | ✅ 완주 | 5위 |
| F | 180 spm | 180.0 spm | 0.0 | - | ❌ 미완주 | 6위 (미완주) |

**특징:**
- 완주자가 미완주자보다 **무조건 높은 순위**
- 미완주자 중 점수가 좋아도 완주자보다 낮은 순위

---

### 3️⃣ HEARTBEAT 경기 (심박수)

**목표:** 목표 심박수를 유지하면서 완주

**신청 시:**
- 시스템이 사용자의 **평균 심박수를 자동으로 목표 값으로 설정**

**순위 결정 기준 (우선순위):**
1. **완주 여부** (완주 > 미완주)
2. **심박수 점수** = `|목표 심박수 - 평균 심박수|` (작을수록 높은 순위)
3. **동점 시**: 경기 소요 시간 짧은 순 (`endAt - startAt`)

**예시:**

| 사용자 | 목표 심박수 | 평균 심박수 | 점수 | 소요 시간 | 완주 여부 | 순위 |
|--------|-----------|-----------|------|----------|----------|------|
| A | 150 bpm | 150.2 bpm | 0.2 | 30분 | ✅ 완주 | 1위 (점수 최소) |
| E | 150 bpm | 149.0 bpm | 1.0 | 35분 | ✅ 완주 | 2위 |
| B | 150 bpm | 148.5 bpm | 1.5 | 28분 | ✅ 완주 | 3위 (동점, 소요 시간 짧음) |
| C | 150 bpm | 148.5 bpm | 1.5 | 32분 | ✅ 완주 | 4위 (동점, 소요 시간 김) |
| D | 150 bpm | 145.0 bpm | 5.0 | 35분 | ✅ 완주 | 5위 |
| F | 150 bpm | 150.0 bpm | 0.0 | - | ❌ 미완주 | 6위 (미완주) |

**특징:**
- 완주자가 미완주자보다 **무조건 높은 순위**
- 미완주자 중 점수가 좋아도 완주자보다 낮은 순위

---

## 동점 처리

### SPEED 경기
- **동점 상황**: 초 단위로 소요 시간을 기록하므로 **동점자 없다고 가정**
- **처리**: 경기 소요 시간(`getDurationInSeconds()`) 기준

### CADENCE & HEARTBEAT 경기
- **동점 상황**: 케이던스/심박수 점수가 같을 때
- **처리**: 경기 소요 시간(`getDurationInSeconds()`) 기준으로 짧은 순

### 구현 상태
✅ **동점 처리 구현 완료**

- `startAt`: 첫 웹소켓 데이터 수신 시점 기록
- `endAt`: 목표 거리 도달 시점 기록
- `getDurationInSeconds()`: 경기 소요 시간 계산 (endAt - startAt)
- 정렬 로직에 `thenComparingLong(GameHistory::getDurationInSeconds)` 적용

---

## 상금 분배

### 총 상금 계산
- 참가 수수료: **1,200원/명**
- 총 상금 = 참가자 수 × 1,200원

### 상금 분배 비율

| 순위 | 상금 비율 | 계산 |
|------|----------|------|
| 1위 | 80% | 총상금 × 0.80 |
| 2위 | 15% | 총상금 × 0.15 |
| 3위 | 5% | 총상금 × 0.05 |
| 4위 이하 | 0% | 상금 없음 |

### 예시

| 참가자 수 | 총 상금 | 1위 | 2위 | 3위 |
|----------|---------|-----|-----|-----|
| 10명 | 12,000원 | 9,600원 | 1,800원 | 600원 |
| 50명 | 60,000원 | 48,000원 | 9,000원 | 3,000원 |
| 100명 | 120,000원 | 96,000원 | 18,000원 | 6,000원 |

---

## ✅ 코드 수정 완료

### 수정된 파일

1. **GameHistory.java**
   - `updateFrom()`: 첫 업데이트 시 `startAt` 기록
   - `markAsDone()`: 완주 시 `endAt` 기록
   - `getDurationInSeconds()`: 경기 소요 시간 계산 메서드 추가

2. **SpeedRankService.java**
   - 완주 여부 → 소요 시간 → 남은 거리 순으로 정렬

3. **CadenceRankService.java**
   - 완주 여부 → 케이던스 점수 → 소요 시간 순으로 정렬

4. **HeartBeatRankService.java**
   - 완주 여부 → 심박수 점수 → 소요 시간 순으로 정렬

5. **AbstractGameRankService.java**
   - `assignRanks()` 버그 수정: 모든 참가자에게 순위 부여
   

---

## 📊 경기별 순위 규칙 요약

| 경기 | 1순위 | 2순위 | 3순위 | 미완주자 |
|------|-------|-------|-------|----------|
| **SPEED** | 완주 여부 | 소요 시간 (짧은 순) | - | 남은 거리 적은 순 |
| **CADENCE** | 완주 여부 | 케이던스 점수 | 소요 시간 (짧은 순) | 점수 무관하게 낮은 순위 |
| **HEARTBEAT** | 완주 여부 | 심박수 점수 | 소요 시간 (짧은 순) | 점수 무관하게 낮은 순위 |

### 핵심 포인트
- **모든 경기**: 완주자 > 미완주자 (무조건)
- **SPEED**: 경기 소요 시간이 짧을수록 높은 순위
- **CADENCE/HEARTBEAT**: 점수가 작을수록 높은 순위, 동점 시 소요 시간 짧은 순
- **소요 시간**: `endAt - startAt` (초 단위)
  - `startAt`: 첫 웹소켓 데이터 수신 시점
  - `endAt`: 목표 거리 도달 시점
