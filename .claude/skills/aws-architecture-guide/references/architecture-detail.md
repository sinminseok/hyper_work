# FunnyRun AWS 아키텍처 상세

## 목차
- [아키텍처 다이어그램](#아키텍처-다이어그램)
- [VPC](#1-vpc)
- [Subnet](#2-subnet)
- [Internet Gateway](#3-internet-gateway)
- [라우팅 테이블](#4-라우팅-테이블)
- [NAT Instance](#5-nat-instance)
- [ALB](#6-alb)
- [보안 그룹](#7-보안-그룹)
- [RDS](#8-rds)
- [트래픽 흐름](#트래픽-흐름)

---

## 아키텍처 다이어그램

```
                            ┌─────────────────────────────────────────────────────────────┐
                            │                           VPC                               │
                            │                       10.0.0.0/16                           │
                            │                                                             │
    인터넷                   │  ┌─────────────────────────────────────────────────────┐   │
      │                     │  │            Public Subnet (10.0.1.0/24, 10.0.2.0/24) │   │
      │                     │  │                                                     │   │
      ▼                     │  │   ┌──────────────┐        ┌──────────────┐         │   │
┌──────────┐                │  │   │ NAT Instance │        │     ALB      │         │   │
│ Internet │◄──────────────►│  │   │  (t3.micro)  │        │              │         │   │
│ Gateway  │                │  │   └──────────────┘        └──────┬───────┘         │   │
└──────────┘                │  │                                  │                 │   │
                            │  └──────────────────────────────────┼─────────────────┘   │
                            │                                     │                     │
                            │                                     ▼                     │
                            │  ┌─────────────────────────────────────────────────────┐   │
                            │  │           Private Subnet (10.0.10.0/24)             │   │
                            │  │                                                     │   │
                            │  │   ┌─────────────────────────────────────────────┐   │   │
                            │  │   │            funny-run-ec2                    │   │   │
                            │  │   │                                             │   │   │
                            │  │   │   ┌─────────────────┐ ┌─────────────────┐   │   │   │
                            │  │   │   │   api-image     │ │  admin-image    │   │   │   │
                            │  │   │   │   (8080)        │ │  (8081)         │   │   │   │
                            │  │   │   └─────────────────┘ └─────────────────┘   │   │   │
                            │  │   │                                             │   │   │
                            │  │   └─────────────────────────────────────────────┘   │   │
                            │  │                                                     │   │
                            │  └──────────────────────────┬──────────────────────────┘   │
                            │                             │                             │
                            │                             ▼                             │
                            │  ┌─────────────────────────────────────────────────────┐   │
                            │  │       DB Subnet (10.0.100.0/24 - Multi AZ)          │   │
                            │  │                                                     │   │
                            │  │              ┌─────────────────┐                    │   │
                            │  │              │   Amazon RDS    │                    │   │
                            │  │              │     MySQL       │                    │   │
                            │  │              └─────────────────┘                    │   │
                            │  │                                                     │   │
                            │  └─────────────────────────────────────────────────────┘   │
                            │                                                             │
                            └─────────────────────────────────────────────────────────────┘
```

---

## 1. VPC

- **CIDR**: `10.0.0.0/16` (65,536개 IP 사용 가능)

---

## 2. Subnet

| 서브넷 | CIDR | 용도 | 특성 |
|--------|------|------|------|
| public-subnet-a | 10.0.1.0/24 | NAT Instance, ALB | 인터넷 접근 가능 |
| public-subnet-c | 10.0.2.0/24 | ALB (가용영역 분산) | 인터넷 접근 가능 |
| private-subnet-a | 10.0.10.0/24 | EC2 (애플리케이션) | 인터넷 직접 접근 불가 |
| db-subnet-a | 10.0.100.0/24 | RDS | 인터넷 접근 불가 |
| db-subnet-c | 10.0.100.0/24 | RDS (가용영역 분산) | 인터넷 접근 불가 |

### 계층형 보안 (Defense in Depth)

```
인터넷
   ↓
[Public Subnet] ← 외부 트래픽을 받는 곳 (ALB, NAT)
   ↓
[Private Subnet] ← 실제 애플리케이션 (보호됨)
   ↓
[DB Subnet] ← 데이터베이스 (가장 보호됨)
```

- 외부에서 EC2로 직접 접근 불가능
- 외부에서 DB로 직접 접근 불가능
- 침투하려면 여러 계층을 뚫어야 함

---

## 3. Internet Gateway

VPC와 인터넷을 연결하는 관문.

```
인터넷 ←→ Internet Gateway ←→ Public Subnet
```

- Public Subnet의 리소스가 인터넷과 통신하려면 필수
- 양방향 통신 가능 (인바운드 + 아웃바운드)

---

## 4. 라우팅 테이블

### Public Subnet 라우팅 테이블

| 목적지 | 대상 | 설명 |
|--------|------|------|
| 10.0.0.0/16 | local | VPC 내부 통신 |
| 0.0.0.0/0 | Internet Gateway | 외부 인터넷으로 나감 |

### Private Subnet 라우팅 테이블

| 목적지 | 대상 | 설명 |
|--------|------|------|
| 10.0.0.0/16 | local | VPC 내부 통신 |
| 0.0.0.0/0 | NAT Instance | 외부 인터넷은 NAT를 통해 |

### DB Subnet 라우팅 테이블

| 목적지 | 대상 | 설명 |
|--------|------|------|
| 10.0.0.0/16 | local | VPC 내부 통신만 |

**라우팅 전략:**
- **Public Subnet**: 인터넷과 직접 통신 필요 (ALB가 사용자 요청 받음)
- **Private Subnet**: 인터넷 필요하지만 직접 노출 안됨 (Docker 이미지 pull 등)
- **DB Subnet**: 인터넷 필요 없음, VPC 내부만 통신

---

## 5. NAT Instance

- **인스턴스 타입**: t3.micro
- **위치**: public-subnet-a

### 필요 이유
- EC2가 Docker Hub에서 이미지 pull
- EC2가 외부 API 호출 (알리고 문자, 이메일 등)
- apt update/install 등 패키지 설치

---

## 6. ALB

- **위치**: public-subnet-a, public-subnet-c (2개 AZ)
- **리스너**: 80(HTTP), 443(HTTPS)
- **대상 그룹**: EC2의 8080(API), 8081(Admin) 포트

### 사용 이유

#### 1. 보안
```
사용자 → ALB (Public) → EC2 (Private)
```
- EC2가 인터넷에 직접 노출되지 않음
- DDoS 공격 시 ALB가 1차 방어선

#### 2. 경로 기반 라우팅
```
/api/* → EC2:8080 (API 서버)
/admin/* → EC2:8081 (Admin 서버)
```

---

## 7. 보안 그룹

### ALB 보안 그룹
| 방향 | 포트 | 소스 | 설명 |
|------|------|------|------|
| 인바운드 | 80 | 0.0.0.0/0 | HTTP |
| 인바운드 | 443 | 0.0.0.0/0 | HTTPS |
| 아웃바운드 | 전체 | 0.0.0.0/0 | 모든 아웃바운드 |

### EC2 보안 그룹
| 방향 | 포트 | 소스 | 설명 |
|------|------|------|------|
| 인바운드 | 8080 | ALB 보안 그룹 | API 서버 |
| 인바운드 | 8081 | ALB 보안 그룹 | Admin 서버 |
| 아웃바운드 | 전체 | 0.0.0.0/0 | 외부 통신 |

### RDS 보안 그룹
| 방향 | 포트 | 소스 | 설명 |
|------|------|------|------|
| 인바운드 | 3306 | EC2 보안 그룹 | MySQL |

### NAT Instance 보안 그룹
| 방향 | 포트 | 소스 | 설명 |
|------|------|------|------|
| 인바운드 | 전체 | 10.0.10.0/24 | Private Subnet에서 오는 트래픽 |
| 아웃바운드 | 전체 | 0.0.0.0/0 | 인터넷으로 나가는 트래픽 |

### 최소 권한 원칙 (Principle of Least Privilege)

```
인터넷 → [ALB만 허용] → ALB → [ALB만 허용] → EC2 → [EC2만 허용] → RDS
```

- ALB만 외부에서 접근 가능
- EC2는 ALB에서만 접근 가능 (SSM으로 접속. System Manager → 플릿 관리자에서 확인)
- RDS는 EC2에서만 접근 가능 (로컬 확인용 SSH 내IP만 열어놓은 상태)

---

## 8. RDS

- **엔진**: MySQL
- **위치**: db-subnet-a, db-subnet-c (Multi-AZ 가능)

### DB Subnet 분리 이유

#### 1. 보안 격리
- 애플리케이션 서브넷과 분리
- 인터넷 라우팅 없음 (완전 격리)

#### 2. Multi-AZ 지원
- 2개 AZ에 서브넷이 있어야 RDS Multi-AZ 배포 가능
- 장애 시 자동 페일오버

---

## 트래픽 흐름

### 사용자 요청 흐름 (인바운드)

```
1. 사용자가 https://funnyrun.com/v1/api/users 요청
2. DNS → ALB의 공인 IP로 연결
3. ALB가 HTTPS 복호화 (SSL Termination)
4. ALB가 EC2:8080으로 HTTP 요청 전달
5. EC2가 RDS에 쿼리
6. 응답을 역순으로 반환
```

### EC2 외부 통신 흐름 (아웃바운드)

```
1. EC2가 docker pull 요청
2. Private Subnet 라우팅 테이블 → NAT Instance로 라우팅
3. NAT Instance가 IP 변환 (SNAT)
4. Internet Gateway → 인터넷
5. 응답을 역순으로 EC2에 전달
```
