package hyper.run.config;

import com.google.auth.oauth2.GoogleCredentials;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Collections;

/**
 * Google Play Developer API 설정 클래스 (개발 환경용)
 * Classpath 또는 파일 시스템에서 Service Account 키를 로드합니다.
 *
 * google.play.enabled=true 일 때만 활성화됩니다.
 * 운영 환경(prod)에서는 GooglePlayConfigS3가 사용됩니다.
 */
@Slf4j
@Configuration
@Profile("!prod")  // prod 프로파일이 아닐 때만 활성화
@ConditionalOnProperty(name = "google.play.enabled", havingValue = "true", matchIfMissing = false)
public class GooglePlayConfig {

    private final ResourceLoader resourceLoader;

    public GooglePlayConfig(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    @Value("${google.play.service-account-key-path}")
    private String serviceAccountKeyPath;

    @Value("${google.play.package-name}")
    private String packageName;

    @Bean
    public GoogleCredentials googleCredentials() {
        try {
            log.info("Google Play Service Account 키 로드 중: {}", serviceAccountKeyPath);

            InputStream inputStream;

            // classpath: 접두사가 있으면 리소스에서 로드
            if (serviceAccountKeyPath.startsWith("classpath:")) {
                Resource resource = resourceLoader.getResource(serviceAccountKeyPath);
                if (!resource.exists()) {
                    throw new IllegalStateException("Google Play Service Account 키 파일을 찾을 수 없습니다: " + serviceAccountKeyPath);
                }
                inputStream = resource.getInputStream();
                log.info("Classpath에서 키 파일 로드 성공");
            } else {
                // 일반 파일 시스템 경로
                File keyFile = new File(serviceAccountKeyPath);
                if (!keyFile.exists()) {
                    throw new IllegalStateException("Google Play Service Account 키 파일을 찾을 수 없습니다: " + serviceAccountKeyPath);
                }
                inputStream = new FileInputStream(keyFile);
                log.info("파일 시스템에서 키 파일 로드 성공");
            }

            GoogleCredentials credentials = GoogleCredentials
                    .fromStream(inputStream)
                    .createScoped(Collections.singleton("https://www.googleapis.com/auth/androidpublisher"));

            log.info("Google Credentials 초기화 성공");
            return credentials;

        } catch (IOException e) {
            log.error("Failed to initialize Google Credentials", e);
            throw new RuntimeException("Google Credentials 초기화 실패: " + e.getMessage(), e);
        }
    }

    @Bean
    public String googlePlayPackageName() {
        return packageName;
    }
}
